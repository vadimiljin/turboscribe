# Name Disambiguation (Разрешение неоднозначности имен)

## Проблема

В документах Product Review часто встречаются люди с одинаковыми именами:
- **Владимир Федоров** (vladimirfedorov@route4me.com) - отвечает за снэпшоты
- **Владимир Жахавец** (vova@route4me.com) - отвечает за Schedule Section

Также встречаются:
- **Уменьшительные имена**: "Вова", "Володя", "Саша", "Оля", "Макс"
- **Разные падежи**: "Владимир", "Владимира", "Владимиру", "Владимиром"
- **Фамилии**: "Федоров", "Федорова", "Федорову", "Федоровым"

Когда в тексте встречается просто "Владимир" или "Вова", нужно понять, о ком именно идет речь.

## Решение

Система автоматически:
1. **Генерирует ВСЕ варианты имен из emails.csv**:
   - Все падежи (Владимир, Владимира, Владимиру, Владимиром)
   - Уменьшительные (Вова, Володя, Саша, Оля, Макс)
   - Английские варианты (Vladimir, Alexander)
   
2. **Разрешает конфликты через LLM API**, анализируя:
   - Контекст упоминания - какие слова рядом с именем
   - Зоны ответственности из Agenda - кто за что отвечает
   - Ключевые слова - технические термины, названия проектов
   - Структуру документа - в какой секции упоминается имя

## Источник правды: emails.csv

**ЕДИНСТВЕННЫЙ** источник данных о людях - файл `emails.csv`:

```csv
Email,Full Name,RU/UA Transcription from ENGLISH
vladimirfedorov@route4me.com,Vladimir Fedorov,Владимир Федоров
vova@route4me.com,Vladimir Zhakhavets,Вова Жахавец
```

Все варианты имен генерируются **автоматически** из этих данных.


## Как это работает

### Шаг 0: Автоматическая генерация вариантов имен

Система читает `emails.csv` и для каждого человека генерирует:

**Для: Vladimir Fedorov (Владимир Федоров)**

1. **Полные имена**: 
   - Vladimir Fedorov
   - Владимир Федоров

2. **Падежи имени**:
   - Именительный: Владимир
   - Родительный: Владимира
   - Дательный: Владимиру
   - Творительный: Владимиром
   - Предложный: Владимире

3. **Падежи фамилии**:
   - Федоров, Федорова, Федорову, Федоровым, Федорове

4. **Уменьшительные**:
   - Вова, Володя, Вовка, Вован (+ их падежи)

5. **Английские**:
   - Vladimir, Vova

**Результат**: ~50+ вариантов для одного человека!

### Шаг 1: Обнаружение конфликтов

После генерации система проверяет, какие варианты встречаются у нескольких людей:

```
[OK] Сгенерировано 487 вариантов имен
[INFO] Неоднозначных вариантов: 12
[INFO] Примеры конфликтов:
   - 'Владимир': Vladimir Fedorov, Vladimir Zhakhavets
   - 'Вова': Vladimir Fedorov, Vladimir Zhakhavets
   - 'Саша': Alexandr Kovtunov, Alexander Dylevskiy
```

### Шаг 2: Извлечение контекста

Для каждого упоминания "Владимир" в документе извлекается контекст (±200 символов):

```
Строка 186: "...Владимир: Хотел бы выделить день между снэпшотами, 
чтобы доделать Legacy конфигуратор (v2), так как там большие правки 
по UI, и работа сейчас не ведется..."
```

### Шаг 3: Анализ Agenda

Система извлекает зоны ответственности из Agenda:

```markdown
## Agenda
- Order Snapshot [[Vladimir Fedorov](mailto:vladimirfedorov@route4me.com)]
- Customer Snapshot [[Vladimir Fedorov](mailto:vladimirfedorov@route4me.com)]
- Customer Locations
  - Schedule Section [[Vladimir Zhakhavets](mailto:vova@route4me.com)]
```

**Результат:**
- Vladimir Fedorov → Order Snapshot, Customer Snapshot
- Vladimir Zhakhavets → Schedule Section

### Шаг 4: Вызов LLM API

LLM анализирует:
- Ключевые слова: "между **снэпшотами**", "**конфигуратор**"
- Зоны ответственности: Vladimir Fedorov отвечает за **снэпшоты**
- Контекст: говорит о своей работе со снэпшотами

**Evidence Score:**
- Vladimir Fedorov: +30 (контекст совпадает) + 20 (ключевые слова) = **50**
- Vladimir Zhakhavets: -20 (контекст противоречит) = **-20**

### Шаг 5: Принятие решения

```json
{
  "resolved_email": "vladimirfedorov@route4me.com",
  "confidence": 0.85,
  "reasoning": [
    "Упоминание 'между снэпшотами' указывает на зону ответственности Vladimir Fedorov",
    "Vladimir Fedorov отвечает за Order Snapshot, Customer Snapshot в Agenda",
    "Legacy конфигуратор не упомянут в зоне ответственности Vladimir Zhakhavets"
  ]
}
```

## Правила разрешения

### Высокий приоритет (confidence > 80%)

1. **Email упомянут рядом** → 100% идентификация
   ```markdown
   [Vladimir Fedorov](mailto:vladimirfedorov@route4me.com) → ТОЧНО Fedorov
   ```

2. **Контекст работы**
   ```
   "между снэпшотами" → тот, кто делает снэпшоты
   "Schedule Section" → тот, кто отвечает за Schedule
   "deploy on prod" → тот, кто делает деплои
   ```

3. **Имя в заголовке секции**
   ```markdown
   ### 8. Дополнительные задачи Владимира (Legacy конфигуратор)
   ```
   → Владимир, который работает с конфигураторами

### Средний приоритет (confidence 50-80%)

1. **Ключевые слова из зоны ответственности**
   - Если в Agenda: "Order Snapshot [[Vladimir Fedorov]]"
   - И в тексте: "Владимир показал Order Snapshot"
   - → Скорее всего Fedorov

2. **Расстояние до секции**
   - Если упоминание в той же секции, что и задачи кандидата
   - → Вероятно этот кандидат

### Низкий приоритет (confidence < 50%)

Если контекста недостаточно → система вернет `NEEDS_HUMAN_REVIEW`

## Интеграция в workflow

### В standardize_product_reviews.py

Добавлены методы:
1. `load_employees_json()` - загрузка базы сотрудников
2. `resolve_name_disambiguation()` - разрешение конфликтов
3. `_call_llm_for_disambiguation()` - вызов LLM API

### Процесс обработки файла

```python
# 1. Загрузка документа
original_content = read_file(source)

# 2. Извлечение всех email и имен
extract_names_from_text(original_content)

# 3. НОВОЕ: Разрешение конфликтов имен
agenda_section = extract_agenda(original_content)
disambiguations = resolve_name_disambiguation(
    original_content, 
    agenda_section
)

# 4. Применение разрешений
for name, email in disambiguations.items():
    name_to_email[name] = email  # Теперь "Владимир" → конкретный email

# 5. Обработка документа с правильной атрибуцией
standardized = process_document(original_content)
```

## Примеры

### Пример 1: Два Владимира

**Входные данные:**
```markdown
## Agenda
- Order Snapshot [[Vladimir Fedorov](mailto:vladimirfedorov@route4me.com)]
- Schedule Section [[Vladimir Zhakhavets](mailto:vova@route4me.com)]

### 8. Дополнительные задачи Владимира
- Владимир: Хотел бы выделить день между снэпшотами...
```

**Результат:**
```
[DISAMB] Разрешение для 'Владимир' (2 кандидатов)...
[INFO] Найдено 5 упоминаний 'Владимир'
[LLM] Уверенность: 85%
   - Упоминание 'между снэпшотами' указывает на зону ответственности Vladimir Fedorov
   - Vladimir Fedorov отвечает за Order Snapshot, Customer Snapshot в Agenda
[OK] 'Владимир' → Vladimir Fedorov (vladimirfedorov@route4me.com)
```

### Пример 2: Два Игоря

**Входные данные:**
```markdown
## Agenda
- Backend API [[Igor Skrynkovskyy](mailto:igor@route4me.com)]
- Mobile Team [[Igor Golovtsov](mailto:igorgolovtsov@route4me.com)]

Игорь сказал, что API готов к релизу...
```

**Результат:**
```
[DISAMB] Разрешение для 'Игорь' (2 кандидатов)...
[LLM] Уверенность: 90%
   - Ключевое слово 'API' совпадает с зоной ответственности Igor Skrynkovskyy
   - Контекст 'API готов к релизу' указывает на Backend API
[OK] 'Игорь' → Igor Skrynkovskyy (igor@route4me.com)
```


## Требования

### Обязательные файлы

1. **emails.csv** - ЕДИНСТВЕННЫЙ источник правды

### Структура emails.csv

```csv
Email,Full Name,RU/UA Transcription from ENGLISH
vladimirfedorov@route4me.com,Vladimir Fedorov,Владимир Федоров
vova@route4me.com,Vladimir Zhakhavets,Вова Жахавец
alexkovtunov@route4me.com,Alexandr Kovtunov,Александр Ковтунов
olga@route4me.com,Olha Skulska,Ольга Скульска
maksym@route4me.com,Maksym Silman,Максим Сильман
```

**Правила:**
- Email = уникальный идентификатор человека
- Full Name = английское полное имя (используется в ссылках)
- RU/UA Transcription = русское/украинское имя (используется в тексте)

### Автоматические варианты

Система **автоматически** генерирует для каждого:

1. **Все падежи** (родительный, дательный, творительный, предложный)
2. **Уменьшительные формы** (Саша, Оля, Макс, Вова, Дима, и т.д.)
3. **Английские варианты** (Alex, Sasha, Vova)

**Не нужно** вручную создавать файлы с вариантами!

## Стоимость и производительность

### Стоимость LLM вызовов

- Модель: `gpt-4o-mini`
- Стоимость: ~$0.0001 за разрешение одного конфликта
- Среднее количество конфликтов в документе: 1-3
- **Итого на документ: ~$0.0003**

### Время выполнения

- Обнаружение конфликтов: <1 сек
- Вызов LLM для одного конфликта: ~1-2 сек
- **Добавочное время на документ: 2-5 сек**

## Логирование

Система выводит подробную информацию о процессе:

```
[DISAMB] Проверка неоднозначных имен (Владимир, Игорь, и т.д.)...
[INFO] Найдено 2 неоднозначных имен: Владимир, Игорь

[DISAMB] Разрешение для 'Владимир' (2 кандидатов)...
[INFO] Найдено 5 упоминаний 'Владимир'
[LLM] Уверенность: 85%
   - Упоминание 'между снэпшотами' указывает на зону ответственности Vladimir Fedorov
   - Vladimir Fedorov отвечает за Order Snapshot, Customer Snapshot в Agenda
[OK] 'Владимир' → Vladimir Fedorov (vladimirfedorov@route4me.com)

[DISAMB] Разрешение для 'Игорь' (2 кандидатов)...
[INFO] Найдено 3 упоминаний 'Игорь'
[LLM] Уверенность: 90%
   - Ключевое слово 'API' совпадает с зоной ответственности Igor Skrynkovskyy
[OK] 'Игорь' → Igor Skrynkovskyy (igor@route4me.com)

[OK] Разрешено 2 конфликтов имен
```


## Ограничения

1. **Требуется Agenda** - без Agenda качество разрешения снижается
2. **Минимальный контекст** - если в документе только "Владимир сказал" без деталей, может не разрешить
3. **Минимум 2 упоминания** - для разрешения нужно хотя бы 2 упоминания имени в документе

## Отладка

### Проверка сгенерированных вариантов

При запуске скрипт выводит статистику:

```
[OK] Загружено 37 email из emails.csv
[OK] Сгенерировано 487 вариантов имен
[INFO] Неоднозначных вариантов: 12
[INFO] Примеры конфликтов:
   - 'Владимир': Vladimir Fedorov, Vladimir Zhakhavets
   - 'Вова': Vladimir Fedorov, Vladimir Zhakhavets
   - 'Саша': Alexandr Kovtunov, Alexander Dylevskiy
```

### Добавление новых уменьшительных

Если нужно добавить уменьшительную форму, редактируйте словарь в `standardize_product_reviews.py`:

```python
DIMINUTIVE_NAMES = {
    'Александр': ['Саша', 'Саня', 'Шура', 'Алекс', 'Саньок'],
    'Владимир': ['Вова', 'Володя', 'Вовка', 'Вован'],
    'Ольга': ['Оля'],  # Добавьте новые здесь
    # ...
}
```

### Проверка конфликтов вручную

```bash
python standardize_product_reviews.py --test --file="4. Product Review 29 May/4.Product_Review_29_May.md"
```

Система автоматически обнаружит и разрешит конфликты.

## Будущие улучшения

1. **Кэширование** - сохранять разрешения для повторного использования
2. **Обучение** - использовать историю разрешений для улучшения точности
3. **Контекст между документами** - учитывать, кто обычно работает над какими задачами
4. **Интерактивный режим** - спрашивать пользователя при низкой уверенности

